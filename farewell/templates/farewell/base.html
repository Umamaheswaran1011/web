{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <meta name="description"
        content="{% block meta_description %}A farewell tribute to the Anti-Gravity Squad - Batch 2026{% endblock %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}?v=11.0">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Caveat:wght@400;500;600;700&family=Patrick+Hand&family=Special+Elite&family=Indie+Flower&family=Reenie+Beanie&display=swap">
    <!-- ===== HTMX for seamless page transitions ===== -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    {% block extra_css %}{% endblock %}
</head>

<body hx-boost="true" hx-select="#main-content" hx-target="#main-content" hx-swap="innerHTML">
    <!-- ===== Toast Notification Container ===== -->
    <div id="toast-container"></div>

    <!-- ===== Loading Splash ===== -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-content">
            <div class="splash-title">The Anti-Gravity Squad</div>
            <div class="splash-subtitle">Batch 2026 ¬∑ Forever in Our Hearts</div>
            <div class="splash-loader"></div>
        </div>
    </div>

    <!-- ===== Persistent Navigation ===== -->
    <nav class="scrapbook-nav" id="mainNav">
        <div class="nav-inner">
            <a href="{% url 'farewell:index' %}" class="nav-brand">üöÄ Anti-Gravity Squad</a>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <span></span><span></span><span></span>
            </button>
            <div class="nav-links" id="navLinks">
                <a href="{% url 'farewell:index' %}"
                    class="nav-link {% if request.resolver_match.url_name == 'index' %}active{% endif %}">üè† Home</a>
                <a href="{% url 'farewell:gallery' %}"
                    class="nav-link {% if request.resolver_match.url_name == 'gallery' or request.resolver_match.url_name == 'event_detail' %}active{% endif %}">üì∏
                    Gallery</a>
                <a href="{% url 'farewell:timeline' %}"
                    class="nav-link {% if request.resolver_match.url_name == 'timeline' %}active{% endif %}">üéì
                    Timeline</a>
                <a href="{% url 'farewell:awards' %}"
                    class="nav-link {% if request.resolver_match.url_name == 'awards' %}active{% endif %}">üèÜ Awards</a>
                <a href="{% url 'farewell:squad_cards' %}"
                    class="nav-link {% if request.resolver_match.url_name == 'squad_cards' %}active{% endif %}">üÉè
                    Cards</a>
                <a href="{% url 'farewell:newspaper' %}"
                    class="nav-link {% if request.resolver_match.url_name == 'newspaper' %}active{% endif %}">üì∞
                    Times</a>
                <button class="navbar-music-toggle" id="navbar-music-toggle" title="Toggle Music">üéµ</button>
                <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode">üåô</button>
            </div>
        </div>
    </nav>

    <!-- ===== Main Content Area (HTMX swaps only this) ===== -->
    <div id="main-content">
        <!-- ===== Header ===== -->
        <header>
            <h1 class="animate-on-scroll fade-in">{{ page_title }}</h1>
            {% block header_extra %}{% endblock %}
        </header>

        {% block content %}{% endblock %}

        <!-- ===== Footer ===== -->
        <footer>
            <p>&copy; 2026 The Anti-Gravity Squad | Forever in Our Hearts ‚ù§Ô∏è</p>
        </footer>
    </div>

    <!-- ===== Audio element ‚Äî outside #main-content so HTMX won't touch it ===== -->
    <audio id="bg-music"></audio>

    {% block extra_js %}{% endblock %}

    <!-- ===== Global JS: Splash, Nav, Animations, Theme, Toast ===== -->
    <script>
        // === Splash Screen ===
        window.addEventListener('load', function () {
            const splash = document.getElementById('splashScreen');
            if (splash) {
                setTimeout(function () {
                    splash.classList.add('splash-hide');
                    setTimeout(function () { splash.style.display = 'none'; }, 600);
                }, 800);
            }
        });

        // === Mobile Nav Toggle ===
        const navToggle = document.getElementById('navToggle');
        const navLinks = document.getElementById('navLinks');
        if (navToggle) {
            navToggle.addEventListener('click', function () {
                navLinks.classList.toggle('show');
                navToggle.classList.toggle('active');
            });
        }

        // === Scroll Animations ===
        function initScrollAnimations() {
            const elements = document.querySelectorAll('.animate-on-scroll:not(.animated)');
            const observer = new IntersectionObserver(function (entries) {
                entries.forEach(function (entry) {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animated');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });
            elements.forEach(function (el) { observer.observe(el); });
        }
        document.addEventListener('DOMContentLoaded', initScrollAnimations);
        // Re-init scroll animations after HTMX swaps new content in
        document.addEventListener('htmx:afterSwap', initScrollAnimations);

        // === Dark/Light Theme Toggle ===
        const themeToggle = document.getElementById('themeToggle');
        function applyTheme(dark) {
            document.body.classList.toggle('dark-theme', dark);
            if (themeToggle) themeToggle.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', dark ? 'dark' : 'light');
        }
        // Load saved preference
        applyTheme(localStorage.getItem('theme') === 'dark');
        if (themeToggle) {
            themeToggle.addEventListener('click', function () {
                applyTheme(!document.body.classList.contains('dark-theme'));
            });
        }

        // === Toast Notifications ===
        function showToast(message, type) {
            type = type || 'success';
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(function () { toast.classList.add('toast-show'); }, 10);
            setTimeout(function () {
                toast.classList.remove('toast-show');
                setTimeout(function () { toast.remove(); }, 400);
            }, 3000);
        }

        // Show toast from URL params (after redirect)
        (function () {
            const params = new URLSearchParams(window.location.search);
            const msg = params.get('msg');
            if (msg) {
                showToast(decodeURIComponent(msg));
                // Clean URL
                const url = new URL(window.location);
                url.searchParams.delete('msg');
                window.history.replaceState({}, '', url);
            }
        })();
        // === Dynamic Navbar Active State for HTMX ===
        function updateNavActiveState() {
            var currentPath = window.location.pathname;
            var navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(function (link) {
                link.classList.remove('active');
                // Compare the link's pathname with the current URL pathname
                var linkPath = new URL(link.href, window.location.origin).pathname;
                if (currentPath === linkPath) {
                    link.classList.add('active');
                }
            });
        }
        // Update on HTMX swap completion
        document.addEventListener('htmx:afterSettle', updateNavActiveState);
        // Also handle browser back/forward navigation
        window.addEventListener('popstate', function () {
            setTimeout(updateNavActiveState, 50);
        });
    </script>

    <!-- ===== Navbar Music Player JS ===== -->
    <script>
        if (!window.musicPlayerInitialized) {
            window.musicPlayerInitialized = true;
            (function () {
                const audio = document.getElementById('bg-music');
                const musicBtn = document.getElementById('navbar-music-toggle');

                // Playlist ‚Äî update these paths to your actual static mp3 files
                const playlist = [
                    '/static/music/song1.mp3',
                    '/static/music/song2.mp3',
                    '/static/music/song3.mp3'
                ];
                var currentIndex = 0;
                var isPlaying = false;

                if (audio) audio.volume = 0.4;

                function loadTrack(index) {
                    if (!audio || !playlist.length) return;
                    audio.src = playlist[index];
                    audio.load();
                }

                function play() {
                    if (!audio) return;
                    // If no src yet, load the current track
                    if (!audio.src || audio.src === window.location.href) {
                        loadTrack(currentIndex);
                    }
                    audio.play().then(function () {
                        isPlaying = true;
                        if (musicBtn) musicBtn.classList.add('playing');
                    }).catch(function () {
                        // Browser blocked autoplay ‚Äî user needs to interact first
                    });
                }

                function pause() {
                    if (!audio) return;
                    audio.pause();
                    isPlaying = false;
                    if (musicBtn) musicBtn.classList.remove('playing');
                }

                function togglePlayPause() {
                    if (isPlaying) {
                        pause();
                    } else {
                        play();
                    }
                }

                // Auto-advance to next song when current one ends
                if (audio) {
                    audio.addEventListener('ended', function () {
                        currentIndex = (currentIndex + 1) % playlist.length;
                        loadTrack(currentIndex);
                        audio.play().then(function () {
                            isPlaying = true;
                            if (musicBtn) musicBtn.classList.add('playing');
                        }).catch(function () { });
                    });
                }

                // Click handler on the navbar toggle
                if (musicBtn) {
                    musicBtn.addEventListener('click', togglePlayPause);
                }
            })();
        }
    </script>
</body>

</html>